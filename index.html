<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="theme-color" content="#7C3AED" />
<title>Remnawave MiniApp</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* ====== Purple theme (light/dark) ====== */
:root { --primary:#7c3aed; --primary-700:#6d28d9; --primary-200:#e9d5ff; --bg:#ffffff; --bg-2:#f3f4f6; --text:#0f172a; --muted:#6b7280; --success:#10b981; --warn:#f59e0b; --danger:#ef4444; --card:#ffffff; --border:rgba(15,23,42,.08); --shadow:0 8px 24px rgba(2,6,23,.08) }
:root[data-theme="dark"]{ --bg:#0f172a; --bg-2:#111827; --text:#e5e7eb; --muted:#94a3b8; --card:#111827; --border:rgba(255,255,255,.12); --shadow:0 10px 28px rgba(0,0,0,.45) }
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
.hidden{display:none!important}
.container{max-width:640px;margin:0 auto;padding:12px 12px 80px}
.header{padding:12px 8px 24px;position:sticky;top:0;background:linear-gradient(180deg, rgba(124,58,237,.12), transparent);backdrop-filter:saturate(140%) blur(4px);z-index:10}
.row{display:flex;gap:10px;align-items:center;justify-content:space-between}
.select,.icon-btn{border:2px solid var(--border);background:var(--card);color:var(--text);border-radius:12px;padding:8px 12px;font-weight:600}
.icon-btn{display:flex;align-items:center;gap:8px;cursor:pointer}
.icon{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2}
.title{font-size:22px;font-weight:800;margin:12px 0 4px;background:linear-gradient(135deg,var(--primary),var(--primary-700));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sub{color:var(--muted);font-size:13px}
.tabs{display:flex;gap:8px;overflow:auto;padding-bottom:8px;margin:8px 0}
.tab{flex:0 0 auto;border:2px solid var(--border);background:var(--card);padding:10px 14px;border-radius:999px;font-weight:700;cursor:pointer;color:var(--muted)}
.tab.active{border-color:var(--primary);color:var(--primary);background:linear-gradient(135deg,rgba(124,58,237,.12),rgba(124,58,237,.04))}
.section{margin-top:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px;margin:10px 0}
.hdr{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
.h5{font-weight:800}
.muted{color:var(--muted)}
.grid{display:grid;gap:10px}
@media(min-width:480px){.grid-2{grid-template-columns:repeat(2,1fr)}.grid-3{grid-template-columns:repeat(3,1fr)}}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border:none;border-radius:12px;cursor:pointer;font-weight:800}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-700));color:#fff}
.btn-outline{background:transparent;border:2px solid var(--primary);color:var(--primary)}
.btn-ghost{background:transparent;color:var(--primary)}
.input{width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--border);background:var(--card);color:var(--text);font-weight:600}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
.badge-green{background:rgba(16,185,129,.15);color:var(--success)}
.badge-red{background:rgba(239,68,68,.15);color:var(--danger)}
.badge-violet{background:rgba(124,58,237,.15);color:var(--primary)}
.row-wrap{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.kbd{padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:var(--bg-2);font-size:12px}
.toast{position:fixed;right:12px;bottom:12px;left:12px;z-index:50}
.toast .msg{margin:6px auto;max-width:640px;background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow);padding:12px 14px;border-radius:12px}
</style>
</head>
<body>
<div class="header">
  <div class="row">
    <select id="lang" class="select" aria-label="Language"><option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option><option value="en">üá¨üáß English</option></select>
    <button id="theme" class="icon-btn" aria-label="Theme"><svg class="icon" viewBox="0 0 24 24"><path d="M12 3v2m0 14v2M4.2 4.2l1.4 1.4m12.8 12.8l1.4 1.4M3 12h2m14 0h2M4.2 19.8l1.4-1.4m12.8-12.8l1.4-1.4"/></svg><span id="themeLabel">Light</span></button>
  </div>
  <div class="title" id="title">Remnawave</div>
  <div class="sub" id="subtitle">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç Mini App</div>
  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="connect" id="tab-connect">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
    <button class="tab" data-tab="plan" id="tab-plan">–ü–æ–¥–ø–∏—Å–∫–∞ / –ë–∞–ª–∞–Ω—Å</button>
    <button class="tab" data-tab="ref" id="tab-ref">–†–µ—Ñ–µ—Ä–∞–ª—ã</button>
    <button class="tab" data-tab="devices" id="tab-devices">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ —Å–µ—Ä–≤–µ—Ä—ã</button>
    <button class="tab" data-tab="settings" id="tab-settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <button class="tab" data-tab="help" id="tab-help">–°–ø—Ä–∞–≤–∫–∞</button>
  </div>
</div>
<div class="container">
  <!-- CONNECT -->
  <section id="sec-connect" class="section">
    <div class="card">
      <div class="hdr"><div class="h5" id="h_connect_quick">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∑–∞ 30 —Å–µ–∫</div><span class="badge badge-violet" id="badge_recommended">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º</span></div>
      <div class="grid grid-2">
        <div>
          <div class="muted" id="p_connect_pick">1) –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É</div>
          <div class="row-wrap" style="margin-top:8px">
            <button class="btn btn-outline" data-platform="ios">üçé iOS</button>
            <button class="btn btn-outline" data-platform="android">ü§ñ Android</button>
            <button class="btn btn-outline" data-platform="pc">üíª PC</button>
            <button class="btn btn-outline" data-platform="tv">üì∫ TV</button>
          </div>
        </div>
        <div>
          <div class="muted" id="p_connect_copy">2) –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –ø–æ–¥–ø–∏—Å–∫–∏</div>
          <div class="row" style="margin-top:8px">
            <input id="subLink" class="input" readonly value="" />
            <button id="copySub" class="btn btn-primary">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="openClient" class="btn btn-primary">–û—Ç–∫—Ä—ã—Ç—å –∫–ª–∏–µ–Ω—Ç</button>
        <button id="testConnect" class="btn btn-ghost">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
      </div>
    </div>
    <div class="card">
      <div class="hdr"><div class="h5" id="h_servers">–°–µ—Ä–≤–µ—Ä—ã</div><span class="muted" id="serversSummary">‚Äî</span></div>
      <div id="servers" class="grid grid-2"></div>
    </div>
  </section>
  
  <!-- PLAN/BALANCE -->
  <section id="sec-plan" class="section hidden">
    <div class="card">
      <div class="hdr"><div class="h5" id="h_subscription">–ü–æ–¥–ø–∏—Å–∫–∞</div><span class="badge badge-green" id="subStatus">‚Äî</span></div>
      <div id="renewal" class="card hidden"></div>
      <div class="grid grid-2">
        <div>
          <div class="muted" id="lbl_period">–ü–µ—Ä–∏–æ–¥</div>
          <div id="periods" class="row-wrap" style="margin-top:8px"></div>
        </div>
        <div>
          <div class="muted" id="lbl_traffic">–¢—Ä–∞—Ñ–∏–∫</div>
          <div id="traffic" class="row-wrap" style="margin-top:8px"></div>
        </div>
        <div>
          <div class="muted" id="lbl_devices">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div>
          <div class="row" style="margin-top:8px">
            <button class="btn btn-outline" id="devMinus">‚àí</button>
            <div class="kbd" id="devValue">1</div>
            <button class="btn btn-outline" id="devPlus">+</button>
          </div>
        </div>
        <div>
          <div class="muted" id="lbl_servers">–°–µ—Ä–≤–µ—Ä—ã</div>
          <div id="srvPick" class="row-wrap" style="margin-top:8px"></div>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="hdr"><div class="h5" id="h_total">–ò—Ç–æ–≥–æ</div></div>
        <div id="priceBox" class="row" style="justify-content:space-between">
          <div>
            <div id="priceCurrent" class="h5">‚Äî</div>
            <div class="muted" id="pricePerMonth">‚Äî</div>
            <div class="muted hidden" id="missing">‚Äî</div>
          </div>
          <div class="row-wrap">
            <span id="discountBadge" class="badge badge-violet hidden"></span>
            <button id="btnBuy" class="btn btn-primary">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="hdr"><div class="h5" id="h_balance">–ë–∞–ª–∞–Ω—Å</div><span class="muted" id="balanceVal">‚Äî</span></div>
      <div class="muted" id="p_fast_topup">–ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
      <div class="row-wrap" style="margin-top:8px">
        <button class="btn btn-outline preset" data-amount="300">+300</button>
        <button class="btn btn-outline preset" data-amount="500">+500</button>
        <button class="btn btn-outline preset" data-amount="1000">+1000</button>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="topupAmount" class="input" placeholder="–°—É–º–º–∞" />
        <button id="topupBtn" class="btn btn-primary">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
      </div>
      <div class="row-wrap" style="margin-top:10px" id="payMethods"></div>
    </div>
  </section>

  <!-- REFERRALS -->
  <section id="sec-ref" class="section hidden">
    <div class="card">
      <div class="hdr"><div class="h5" id="h_ref">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</div></div>
      <div class="row">
        <input id="refLink" class="input" readonly value="" />
        <button id="copyRef" class="btn btn-primary">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <div class="grid grid-3" style="margin-top:10px">
        <div class="card"><div class="muted">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div><div id="refInvited" class="h5">0</div></div>
        <div class="card"><div class="muted">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div><div id="refActive" class="h5">0</div></div>
        <div class="card"><div class="muted">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div><div id="refEarned" class="h5">‚Äî</div></div>
      </div>
    </div>
  </section>

  <!-- DEVICES & SERVERS -->
  <section id="sec-devices" class="section hidden">
    <div class="card">
      <div class="hdr"><div class="h5">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div></div>
      <div id="devices" class="grid"></div>
    </div>
    <div class="card">
      <div class="hdr"><div class="h5">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã</div></div>
      <div id="allServers" class="grid grid-2"></div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="sec-settings" class="section hidden">
    <div class="card">
      <div class="hdr"><div class="h5">–ê–≤—Ç–æ–ø–ª–∞—Ç—ë–∂</div><span id="autopayState" class="badge">‚Äî</span></div>
      <div id="autopayDays" class="row-wrap"></div>
      <div class="row-wrap" style="margin-top:8px">
        <button class="btn btn-outline" data-autopay="enable">–í–∫–ª—é—á–∏—Ç—å</button>
        <button class="btn btn-outline" data-autopay="disable">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
      </div>
    </div>
    <div class="card">
      <div class="hdr"><div class="h5">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</div></div>
      <div class="row-wrap">
        <button id="toRu" class="btn btn-outline">RU</button>
        <button id="toEn" class="btn btn-outline">EN</button>
        <button id="toggleTheme" class="btn btn-outline">Light/Dark</button>
      </div>
    </div>
  </section>

  <!-- HELP -->
  <section id="sec-help" class="section hidden">
    <div class="card">
      <div class="hdr"><div class="h5">FAQ</div></div>
      <div class="grid" id="faq"></div>
    </div>
  </section>
</div>
<div id="toasts" class="toast"></div>
<script>
const tg = window.Telegram?.WebApp || { initData:'', initDataUnsafe:{}, ready:()=>{}, expand:()=>{}, themeParams:{}, onEvent:()=>{} };
try{tg.ready();tg.expand();}catch{}
const S = { lang:'ru', theme:'light', user:null, sub:null, balanceK:0, currency:'RUB', referral:null, branding:null };
const I18N={ru:{title:'Remnawave',subtitle:'–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç Mini App',connect:'–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ',plan:'–ü–æ–¥–ø–∏—Å–∫–∞ / –ë–∞–ª–∞–Ω—Å',ref:'–†–µ—Ñ–µ—Ä–∞–ª—ã',devices:'–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ —Å–µ—Ä–≤–µ—Ä—ã',settings:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏',help:'–°–ø—Ä–∞–≤–∫–∞',copy:'–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å',openClient:'–û—Ç–∫—Ä—ã—Ç—å –∫–ª–∏–µ–Ω—Ç',testConn:'–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ',period:'–ü–µ—Ä–∏–æ–¥',traffic:'–¢—Ä–∞—Ñ–∏–∫',devicesL:'–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',serversL:'–°–µ—Ä–≤–µ—Ä—ã',total:'–ò—Ç–æ–≥–æ',buy:'–û—Ñ–æ—Ä–º–∏—Ç—å',balance:'–ë–∞–ª–∞–Ω—Å',fastTopup:'–ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ',enable:'–í–∫–ª—é—á–∏—Ç—å',disable:'–û—Ç–∫–ª—é—á–∏—Ç—å',same:'–í –¥–µ–Ω—å —Å–ø–∏—Å–∞–Ω–∏—è',day1:'–ó–∞ 1 –¥–µ–Ω—å',day3:'–ó–∞ 3 –¥–Ω—è',toastCopied:'–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ',toastError:'–û—à–∏–±–∫–∞'},en:{title:'Remnawave',subtitle:'Personal Mini App',connect:'Connect',plan:'Plan / Balance',ref:'Referrals',devices:'Devices & Servers',settings:'Settings',help:'Help',copy:'Copy',openClient:'Open client',testConn:'Test connection',period:'Period',traffic:'Traffic',devicesL:'Devices',serversL:'Servers',total:'Total',buy:'Purchase',balance:'Balance',fastTopup:'Quick top up',enable:'Enable',disable:'Disable',same:'On renewal day',day1:'1 day before',day3:'3 days before',toastCopied:'Copied',toastError:'Error'}};
function t(k){return I18N[S.lang]?.[k]||I18N.ru[k]||k}
function moneyK(k){if(k==null)return '‚Äî';try{const v=(k/100);return new Intl.NumberFormat(S.lang,{style:'currency',currency:S.currency||'RUB'}).format(v)}catch{return (k/100)+' '+(S.currency||'RUB')}}
(function init(){const lsL=localStorage.getItem('miniapp-lang');const lsT=localStorage.getItem('miniapp-theme');S.lang=(lsL||tg?.initDataUnsafe?.user?.language_code||'ru').startsWith('ru')?'ru':'en';S.theme=lsT||(tg?.themeParams?.bg_color&&tg.themeParams.bg_color!=='#ffffff'?'dark':'light');applyLang();applyTheme();})();
function applyLang(){document.getElementById('lang').value=S.lang;document.getElementById('title').textContent=t('title');document.getElementById('subtitle').textContent=t('subtitle');['connect','plan','ref','devices','settings','help'].forEach(id=>{document.getElementById('tab-'+id).textContent=t(id)})}
function applyTheme(){document.documentElement.setAttribute('data-theme',S.theme);document.getElementById('themeLabel').textContent=S.theme==='dark'?'Dark':'Light'}
document.getElementById('lang').addEventListener('change',e=>{S.lang=e.target.value;localStorage.setItem('miniapp-lang',S.lang);applyLang();renderAll()});['theme','toggleTheme'].forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('click',()=>{S.theme=S.theme==='dark'?'light':'dark';localStorage.setItem('miniapp-theme',S.theme);applyTheme()})});
const tabs=document.getElementById('tabs');tabs.addEventListener('click',e=>{const b=e.target.closest('.tab');if(!b)return;document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));b.classList.add('active');const k=b.dataset.tab;document.querySelectorAll('section[id^="sec-"]').forEach(s=>s.classList.add('hidden'));document.getElementById('sec-'+k).classList.remove('hidden');if(k==='plan') loadPurchaseOptions(); if(k==='devices') loadDevicesAndServers(); if(k==='ref') renderRef(); if(k==='connect') renderConnect()});
function toast(msg){const wrap=document.getElementById('toasts');const d=document.createElement('div');d.className='msg';d.textContent=msg;wrap.appendChild(d);setTimeout(()=>{d.style.opacity='0';setTimeout(()=>d.remove(),300)},2400)}
const API='/miniapp';
async function api(path, body={}){const res=await fetch(API+path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({init_data:tg?.initData||'',...body})});if(!res.ok) throw new Error('HTTP '+res.status);return await res.json()}
async function bootstrap(){try{const d=await api('/subscription');S.user=d.user;S.balanceK=d.balance_kopeks??Math.round((d.balance_rubles||0)*100);S.currency=d.balance_currency||'RUB';S.sub=d;S.referral=d.referral;S.branding=d.branding;renderAll()}catch(e){console.error(e);toast(t('toastError'))}}
function renderAll(){renderConnect();renderPlan();renderRef();}
// CONNECT
function renderConnect(){document.getElementById('h_connect_quick').textContent=S.lang==='ru'?'–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∑–∞ 30 —Å–µ–∫':'Connect in 30s';document.getElementById('badge_recommended').textContent=S.lang==='ru'?'–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º':'Recommended';document.getElementById('p_connect_pick').textContent=S.lang==='ru'?'1) –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É':'1) Pick your platform';document.getElementById('p_connect_copy').textContent=S.lang==='ru'?'2) –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –ø–æ–¥–ø–∏—Å–∫–∏':'2) Copy subscription link';document.getElementById('openClient').textContent=t('openClient');document.getElementById('testConnect').textContent=t('testConn');const link=S.sub?.subscription_url||S.sub?.happ_link||'';document.getElementById('subLink').value=link;loadServersSummary()}
async function loadServersSummary(){try{const d=S.sub;const wrap=document.getElementById('servers');wrap.innerHTML='';(d.connected_servers||[]).forEach(s=>{const c=document.createElement('div');c.className='card';c.innerHTML=`<div class="row" style="justify-content:space-between;gap:8px"><div class="row" style="gap:8px"><div class="kbd">üåê</div><div><div class="h5">${s.name}</div></div></div><button class="btn btn-outline" data-uuid="${s.uuid}">–û—Ç–∫–ª—é—á–∏—Ç—å</button></div>`;wrap.appendChild(c)});document.getElementById('serversSummary').textContent=`${(d.connected_servers||[]).length}`;wrap.addEventListener('click',e=>{const b=e.target.closest('button[data-uuid]');if(!b)return;toggleServer(b.dataset.uuid)})}catch(e){}}
async function toggleServer(uuid){try{await api('/subscription/servers/update',{serverUuids:[uuid]});toast('OK');const d=await api('/subscription');S.sub=d;renderConnect()}catch(e){toast(t('toastError'))}}
// PLAN & BALANCE
let PurchaseOpts=null;async function renderPlan(){document.getElementById('h_subscription').textContent=S.lang==='ru'?'–ü–æ–¥–ø–∏—Å–∫–∞':'Subscription';const st=document.getElementById('subStatus');st.textContent=S.sub?.user?.subscription_status||'‚Äî';document.getElementById('h_total').textContent=t('total');document.getElementById('h_balance').textContent=t('balance');document.getElementById('p_fast_topup').textContent=t('fastTopup');document.getElementById('btnBuy').textContent=t('buy');document.getElementById('balanceVal').textContent=S.sub?.balance_label||moneyK(S.balanceK);renderRenewal()}
async function renderRenewal(){try{const r=await api('/subscription/renewal/options');const box=document.getElementById('renewal');box.innerHTML='';if(!(r.periods||[]).length){box.classList.add('hidden');return}box.classList.remove('hidden');const cur=document.createElement('div');cur.className='row-wrap';(r.periods||[]).forEach(p=>{const b=document.createElement('button');b.className='btn '+(p.isRecommended?'btn-primary':'btn-outline');b.textContent=`${p.title||p.days||p.months||''} ‚Ä¢ ${p.priceLabel||moneyK(p.priceKopeks||0)}${p.discountPercent?` ‚Ä¢ ‚àí${p.discountPercent}%`:''}${p.pricePerMonthLabel?` ‚Ä¢ ${p.pricePerMonthLabel}`:''}`;b.addEventListener('click',()=>doRenew(p.id));cur.appendChild(b)});box.appendChild(cur)}catch(e){}}
async function doRenew(periodId){try{const r=await api('/subscription/renewal',{periodId});if(r.success){toast('–ü—Ä–æ–¥–ª–µ–Ω–æ');const d=await api('/subscription');S.sub=d;renderPlan()}else toast(t('toastError'))}catch(e){toast(t('toastError'))}}
async function loadPurchaseOptions(){try{PurchaseOpts=await api('/subscription/purchase/options');renderPurchaseSelector(PurchaseOpts)}catch(e){console.error(e)}}
function renderPurchaseSelector(opts){const pr=document.getElementById('periods');const tf=document.getElementById('traffic');const sp=document.getElementById('srvPick');pr.innerHTML='';tf.innerHTML='';sp.innerHTML='';const data=opts.data||{};const periods=data.periods||data.periodOptions||[];const traffic=data.traffic||data.trafficOptions||[];const servers=(data.servers?.available)||data.servers||[];periods.forEach(p=>{const b=document.createElement('button');b.className='btn btn-outline';b.dataset.val=p.id||p.value;const perMonth=p.pricePerMonthLabel?` ‚Ä¢ ${p.pricePerMonthLabel}`:'';const save=p.discountPercent?` ‚Ä¢ ‚àí${p.discountPercent}%`:'';b.textContent=`${p.title||p.label||p.id}${save}${perMonth}`;b.addEventListener('click',()=>preview({periodId:p.id||p.value}));pr.appendChild(b)});traffic.forEach(x=>{const b=document.createElement('button');b.className='btn btn-outline';b.dataset.val=x.value; b.textContent=x.label||(`${x.value} GB`);b.addEventListener('click',()=>preview({trafficValue:x.value}));tf.appendChild(b)});servers.slice(0,10).forEach(s=>{const b=document.createElement('button');b.className='btn btn-outline';b.textContent=s.name||s.uuid;b.addEventListener('click',()=>{preview({serverUuids:[s.uuid]})});sp.appendChild(b)});document.getElementById('devMinus').onclick=()=>preview({deviceLimit:Math.max(1,((preview.state?.deviceLimit)||1)-1)});document.getElementById('devPlus').onclick=()=>preview({deviceLimit:Math.min( (data.devices?.max||10), ((preview.state?.deviceLimit)||1)+1)});document.getElementById('btnBuy').onclick=purchase}
async function preview(delta){preview.state=preview.state||{};Object.assign(preview.state,delta);try{const r=await api('/subscription/purchase/preview',{ selection:preview.state });const pv=r.preview||{};document.getElementById('priceCurrent').textContent=pv.priceLabel||moneyK(pv.totalKopeks||0);document.getElementById('pricePerMonth').textContent=pv.pricePerMonthLabel||'';const disc = pv.discountPercent;const badge=document.getElementById('discountBadge'); if(disc){badge.textContent=`–í—ã–≥–æ–¥–∞ ${disc}%`;badge.classList.remove('hidden')}else{badge.classList.add('hidden')}const miss=document.getElementById('missing'); if(pv.missingAmountKopeks>0){miss.classList.remove('hidden');miss.textContent=`–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç ${moneyK(pv.missingAmountKopeks)}`}else miss.classList.add('hidden')}catch(e){}}
async function purchase(){try{const r=await api('/subscription/purchase',{ selection:preview.state });if(r.success){toast('–û—Ñ–æ—Ä–º–ª–µ–Ω–æ');const d=await api('/subscription');S.sub=d;renderPlan()}else toast(t('toastError'))}catch(e){toast(t('toastError'))}}
// Payments
async function loadPayments(){const pm=await api('/payments/methods');const w=document.getElementById('payMethods');w.innerHTML='';(pm.methods||[]).forEach(m=>{const b=document.createElement('button');b.className='btn btn-outline';b.textContent=m.name||m.id;b.dataset.method=m.id;w.appendChild(b)});w.onclick=(e)=>{const b=e.target.closest('button[data-method]');if(!b)return;const amt=parseFloat(document.getElementById('topupAmount').value||0)||300;createPayment(amt,b.dataset.method)}}
async function createPayment(amount, method){try{const payload = Number.isInteger(amount)?{amountKopeks:amount*100}:{amountRubles:amount};const r=await api('/payments/create',{method, ...payload});if(r.payment_url){window.open(r.payment_url,'_blank')}pollPayment([{method, paymentId:r.extra?.paymentId, paymentLinkId:r.extra?.paymentLinkId, invoiceId:r.extra?.invoiceId, startedAt:new Date().toISOString()}])}catch(e){toast(t('toastError'))}}
async function pollPayment(items){const start=Date.now();const wait=ms=>new Promise(r=>setTimeout(r,ms));while(Date.now()-start<180000){try{const s=await api('/payments/status',{payments:items});const ok=(s.results||[]).some(x=>x.is_paid||x.status==='success');if(ok){toast('–ü–ª–∞—Ç—ë–∂ –∑–∞—á–∏—Å–ª–µ–Ω');const d=await api('/subscription');S.sub=d;renderPlan();return}const bad=(s.results||[]).some(x=>x.status==='failed'||x.status==='expired');if(bad){toast('–ü–ª–∞—Ç—ë–∂ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω');return}}catch(e){}await wait(5000)}}
// REFERRALS
function renderRef(){const r=S.referral||{};document.getElementById('refLink').value=r.referral_link||'';document.getElementById('refInvited').textContent=r.stats?.invited_count||0;document.getElementById('refActive').textContent=r.stats?.active_referrals_count||0;document.getElementById('refEarned').textContent=r.stats?.total_earned_label||moneyK(r.stats?.total_earned_kopeks||0)}
// DEVICES & SERVERS
async function loadDevicesAndServers(){try{const d=S.sub;const w=document.getElementById('devices');w.innerHTML='';(d.connected_devices||[]).forEach(dev=>{const c=document.createElement('div');c.className='row';c.style.justifyContent='space-between';c.innerHTML=`<div><div class="h5">${dev.device_model||dev.platform||'Device'}</div><div class="muted">${dev.platform||''} ‚Ä¢ ${dev.last_seen||''}</div></div><button class="btn btn-outline" data-hwid="${dev.hwid||''}">–°–±—Ä–æ—Å–∏—Ç—å</button>`;w.appendChild(c)});w.onclick=async e=>{const b=e.target.closest('button[data-hwid]');if(!b)return;try{await api('/devices/remove',{hwid:b.dataset.hwid});toast('–°–±—Ä–æ—à–µ–Ω–æ');const d=await api('/subscription');S.sub=d;loadDevicesAndServers()}catch{toast(t('toastError'))}};const s=document.getElementById('allServers');s.innerHTML='';(d.connected_servers||[]).concat([]).forEach(x=>{const c=document.createElement('div');c.className='card';c.innerHTML=`<div class="row" style="justify-content:space-between"><div class="row" style="gap:8px"><div class="kbd">üåê</div><div><div class="h5">${x.name}</div></div></div><button class="btn btn-outline" data-uuid="${x.uuid}">–û—Ç–∫–ª—é—á–∏—Ç—å</button></div>`;s.appendChild(c)});s.onclick=e=>{const b=e.target.closest('button[data-uuid]');if(!b)return;toggleServer(b.dataset.uuid)}}catch(e){}}
// FAQ
async function loadFaq(){try{const d=S.sub?.faq;const w=document.getElementById('faq');w.innerHTML='';(d?.items||[]).forEach(it=>{const c=document.createElement('div');c.className='card';c.innerHTML=`<div class="h5">${it.title||''}</div><div class="muted">${it.content||''}</div>`;w.appendChild(c)})}catch(e){}}
// Actions
['copySub','copyRef'].forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('click',async()=>{const val=document.getElementById(id==='copySub'?'subLink':'refLink').value;try{await navigator.clipboard.writeText(val);toast(t('toastCopied'))}catch{toast(t('toastError'))}})});
document.getElementById('openClient').onclick=()=>{const link=document.getElementById('subLink').value;if(link)window.open(link,'_blank')};
document.getElementById('testConnect').onclick=()=>toast('–ü—Ä–æ–≤–µ—Ä—è–µ–º‚Ä¶');
document.getElementById('topupBtn').onclick=()=>{const amt=parseFloat(document.getElementById('topupAmount').value||0);if(amt>0)createPayment(amt)};document.querySelectorAll('.preset').forEach(p=>p.onclick=()=>{document.getElementById('topupAmount').value=p.dataset.amount});
tg.onEvent?.('themeChanged',()=>{const dark=tg?.themeParams?.bg_color&&tg.themeParams.bg_color!=='#ffffff';S.theme=dark?'dark':'light';applyTheme()});
bootstrap();loadPayments();loadFaq();
</script>
</body>
</html>
