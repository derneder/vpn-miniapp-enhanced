<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>SecureVPN</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            /* Color System */
            --color-primary: #2563eb;
            --color-primary-hover: #1d4ed8;
            --color-primary-light: #dbeafe;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            --color-info: #3b82f6;
            
            /* Telegram Theme Variables */
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2563eb;
            --tg-theme-button-color: #2563eb;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f1f5f9;
            
            /* Semantic Colors */
            --bg-primary: var(--tg-theme-bg-color);
            --bg-secondary: var(--tg-theme-secondary-bg-color);
            --text-primary: var(--tg-theme-text-color);
            --text-secondary: var(--tg-theme-hint-color);
            --accent: var(--tg-theme-button-color);
            --accent-text: var(--tg-theme-button-text-color);
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            
            /* Transitions */
            --transition-fast: 0.15s ease-in-out;
            --transition-normal: 0.25s ease-in-out;
            --transition-slow: 0.4s ease-in-out;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --tg-theme-bg-color: #1a1a1a;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #a1a1aa;
            --tg-theme-secondary-bg-color: #262626;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.5), 0 4px 6px -4px rgb(0 0 0 / 0.4);
        }

        /* Reset & Base */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
        .text-center { text-align: center; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: var(--spacing-sm); }
        .gap-4 { gap: var(--spacing-md); }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .z-50 { z-index: 50; }
        .z-60 { z-index: 60; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 500px; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-down { animation: slideDown 0.3s ease-out; }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse 2s infinite; }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            gap: var(--spacing-lg);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--bg-secondary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            font-size: 1.125rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* App Layout */
        .app {
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        .app-header {
            padding: var(--spacing-md) var(--spacing-md) var(--spacing-xl);
            background: linear-gradient(135deg, var(--accent), #1e40af);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -30%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            pointer-events: none;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            position: relative;
            z-index: 1;
        }

        .language-select {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-md);
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 0.875rem;
            font-weight: 600;
            appearance: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            min-width: 120px;
        }

        .language-select:hover, .language-select:focus {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            outline: none;
        }

        .theme-toggle {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .theme-icon {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .hero-section {
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .logo-icon {
            font-size: 2.5rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .logo-text {
            font-size: 2rem;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .hero-subtitle {
            font-size: 1.125rem;
            opacity: 0.9;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            padding: 0 var(--spacing-md) var(--spacing-2xl);
            margin-top: calc(-1 * var(--spacing-lg));
            position: relative;
            z-index: 2;
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all var(--transition-normal);
        }

        [data-theme="dark"] .card {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .card-header {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .card-content {
            padding: var(--spacing-lg);
        }

        .card-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            background: rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] .card-footer {
            border-color: rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
        }

        /* User Status Card */
        .user-status-card .card-header {
            border: none;
            padding-bottom: var(--spacing-md);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #1e40af);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            flex-shrink: 0;
            box-shadow: var(--shadow-md);
        }

        .user-details {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-xl);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .status-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        .status-badge.active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--color-success);
        }

        .status-badge.expired {
            background: rgba(239, 68, 68, 0.1);
            color: var(--color-error);
        }

        .status-badge.trial {
            background: rgba(245, 158, 11, 0.1);
            color: var(--color-warning);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: var(--spacing-md);
            padding-top: var(--spacing-lg);
        }

        .stat-item {
            text-align: center;
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            transition: all var(--transition-fast);
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent), #1e40af);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Quick Actions */
        .quick-actions .card-header {
            display: none;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            padding: var(--spacing-lg);
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-lg) var(--spacing-md);
            background: var(--bg-secondary);
            border: none;
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            min-height: 80px;
        }

        .action-btn:hover {
            background: var(--accent);
            color: var(--accent-text);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .action-icon {
            font-size: 1.5rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--accent-text);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--color-primary-hover);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--accent);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--accent);
            color: var(--accent-text);
            transform: translateY(-1px);
        }

        .btn-ghost {
            background: transparent;
            color: var(--accent);
        }

        .btn-ghost:hover:not(:disabled) {
            background: rgba(37, 99, 235, 0.1);
        }

        /* Expandable Sections */
        .expandable-section {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .expandable-section {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .section-header {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-lg);
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .section-header:hover {
            background: var(--bg-secondary);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: 1.125rem;
            font-weight: 700;
        }

        .section-icon {
            font-size: 1.25rem;
        }

        .section-summary {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-left: auto;
            margin-right: var(--spacing-md);
        }

        .expand-icon {
            width: 24px;
            height: 24px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: transform var(--transition-normal);
        }

        .expandable-section.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .section-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .expandable-section.expanded .section-content {
            max-height: 1000px;
            opacity: 1;
            padding: 0 var(--spacing-lg) var(--spacing-lg);
        }

        /* Error State */
        .error-state {
            text-align: center;
            padding: var(--spacing-2xl) var(--spacing-lg);
            margin: var(--spacing-2xl) var(--spacing-md);
        }

        .error-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-lg);
            opacity: 0.6;
        }

        .error-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: var(--spacing-md);
        }

        .error-message {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xl);
        }

        /* Modals */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
            padding: var(--spacing-lg);
            backdrop-filter: blur(4px);
        }

        .modal {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-lg);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .modal-header {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--color-error);
            color: white;
        }

        .modal-close svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 2;
        }

        .modal-content {
            padding: var(--spacing-lg);
        }

        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
        }

        [data-theme="dark"] .modal-footer {
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: calc(var(--spacing-lg) + env(safe-area-inset-bottom, 0));
            right: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            background: linear-gradient(135deg, var(--accent), #1e40af);
            color: white;
            border: none;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-lg);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            z-index: 50;
        }

        .fab:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 10px 10px -5px rgb(0 0 0 / 0.04);
        }

        .fab:active {
            transform: scale(0.98);
        }

        .fab-icon {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            z-index: 70;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            max-width: 320px;
        }

        .toast {
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--accent);
            animation: fadeIn 0.3s ease-out;
        }

        .toast.success {
            border-left-color: var(--color-success);
        }

        .toast.error {
            border-left-color: var(--color-error);
        }

        .toast.warning {
            border-left-color: var(--color-warning);
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .toast-message {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all var(--transition-fast);
        }

        [data-theme="dark"] .form-input {
            border-color: rgba(255, 255, 255, 0.2);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-secondary);
        }

        /* Promo Offers */
        .promo-offers {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .promo-offer {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            position: relative;
            overflow: hidden;
        }

        .promo-offer::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -30%;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }

        .promo-offer-content {
            position: relative;
            z-index: 1;
        }

        .promo-offer-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
        }

        .promo-offer-description {
            opacity: 0.9;
            margin-bottom: var(--spacing-md);
        }

        .promo-offer-action {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .promo-offer-action:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Payment Methods */
        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .payment-method {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .payment-method:hover {
            border-color: var(--accent);
            background: var(--color-primary-light);
        }

        .payment-method-icon {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
        }

        .payment-method-info {
            flex: 1;
        }

        .payment-method-name {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .payment-method-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Device List */
        .device-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .device-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            transition: all var(--transition-fast);
        }

        .device-item:hover {
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .device-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .device-icon {
            font-size: 1.5rem;
            opacity: 0.7;
        }

        .device-details {
            flex: 1;
        }

        .device-name {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .device-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .device-action {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-error);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .device-action:hover {
            background: #dc2626;
        }

        /* Server List */
        .server-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--spacing-md);
        }

        .server-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .server-item:hover {
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .server-item.connected {
            background: var(--color-primary-light);
            border: 2px solid var(--accent);
        }

        .server-flag {
            font-size: 2rem;
            width: 40px;
            text-align: center;
        }

        .server-info {
            flex: 1;
        }

        .server-name {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .server-location {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .server-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.875rem;
        }

        .server-status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-success);
            animation: pulse 2s infinite;
        }

        /* Responsive Design */
        @media (max-width: 640px) {
            .main-content {
                padding-left: var(--spacing-sm);
                padding-right: var(--spacing-sm);
            }

            .actions-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .server-list {
                grid-template-columns: 1fr;
            }

            .modal {
                margin: var(--spacing-sm);
                max-height: calc(100vh - 2rem);
            }

            .fab {
                bottom: calc(var(--spacing-md) + env(safe-area-inset-bottom, 0));
                right: var(--spacing-md);
            }

            .toast-container {
                top: var(--spacing-md);
                right: var(--spacing-md);
                left: var(--spacing-md);
                max-width: none;
            }
        }

        /* Subscription specific styles */
        .subscription-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all var(--transition-fast);
            margin-bottom: var(--spacing-md);
        }

        .subscription-option:hover,
        .subscription-option.selected {
            border-color: var(--accent);
            background: var(--color-primary-light);
        }

        .subscription-info {
            flex: 1;
        }

        .subscription-title {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .subscription-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .subscription-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
        }

        .subscription-price-period {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Loading states */
        .loading-section {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-2xl);
            color: var(--text-secondary);
        }

        .loading-section .loading-spinner {
            width: 32px;
            height: 32px;
            margin-right: var(--spacing-md);
        }

        /* Empty states */
        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }

        .empty-state-title {
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        /* Stepper component */
        .stepper {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
        }

        .stepper-button {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--accent);
            color: white;
            font-size: 1.125rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .stepper-button:hover:not(:disabled) {
            background: var(--color-primary-hover);
        }

        .stepper-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stepper-value {
            font-size: 1.25rem;
            font-weight: 700;
            min-width: 60px;
            text-align: center;
        }

        .stepper-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text" data-i18n="app.loading">Loading...</div>
    </div>

    <!-- Main App -->
    <div id="app" class="app hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="header-controls">
                <select id="languageSelect" class="language-select" aria-label="Select language">
                    <option value="en">üá¨üáß English</option>
                    <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                </select>
                <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
                    <svg class="theme-icon sun-icon" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="5"/>
                        <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42m12.72-12.72l1.42-1.42"/>
                    </svg>
                    <svg class="theme-icon moon-icon hidden" viewBox="0 0 24 24">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
            </div>
            
            <div class="hero-section">
                <div class="logo">
                    <div class="logo-icon">üõ°Ô∏è</div>
                    <h1 class="logo-text" data-i18n="app.name">SecureVPN</h1>
                </div>
                <p class="hero-subtitle" data-i18n="app.subtitle">Fast & Secure Connection</p>
            </div>
        </header>

        <!-- Error State -->
        <div id="errorState" class="error-state hidden">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2 class="error-title" data-i18n="error.title">Something went wrong</h2>
            <p class="error-message" data-i18n="error.message">Please try again later</p>
            <button id="retryButton" class="btn btn-primary" data-i18n="error.retry">Retry</button>
        </div>

        <!-- Main Content -->
        <main id="mainContent" class="main-content hidden">
            <!-- User Status Card -->
            <section class="card user-status-card" id="userStatusCard">
                <div class="card-header">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-details">
                            <h3 class="user-name" id="userName">User</h3>
                            <span class="status-badge active" id="statusBadge" data-i18n="status.active">Active</span>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="daysLeft">‚Äî</div>
                        <div class="stat-label" data-i18n="stats.days_left">Days Left</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="serversCount">‚Äî</div>
                        <div class="stat-label" data-i18n="stats.servers">Servers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="devicesCount">‚Äî</div>
                        <div class="stat-label" data-i18n="stats.devices">Devices</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="balanceAmount">‚Äî</div>
                        <div class="stat-label" data-i18n="stats.balance">Balance</div>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="card quick-actions" id="quickActions">
                <div class="actions-grid">
                    <button class="action-btn" id="connectBtn">
                        <div class="action-icon">üöÄ</div>
                        <span data-i18n="actions.connect">Connect VPN</span>
                    </button>
                    <button class="action-btn" id="renewBtn">
                        <div class="action-icon">üîÑ</div>
                        <span data-i18n="actions.renew">Renew</span>
                    </button>
                    <button class="action-btn" id="topupBtn">
                        <div class="action-icon">üí≥</div>
                        <span data-i18n="actions.topup">Top Up</span>
                    </button>
                    <button class="action-btn" id="settingsBtn">
                        <div class="action-icon">‚öôÔ∏è</div>
                        <span data-i18n="actions.settings">Settings</span>
                    </button>
                </div>
            </section>

            <!-- Promo Offers -->
            <section id="promoOffers" class="promo-offers hidden"></section>

            <!-- Subscription Management -->
            <section class="expandable-section" id="subscriptionSection">
                <button class="section-header" data-section="subscription">
                    <div class="section-title">
                        <span class="section-icon">üì¶</span>
                        <span data-i18n="subscription.title">Subscription</span>
                    </div>
                    <div class="section-summary" id="subscriptionSummary"></div>
                    <svg class="expand-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5"/>
                    </svg>
                </button>
                <div class="section-content" id="subscriptionContent">
                    <div class="loading-section">
                        <div class="loading-spinner"></div>
                        <span data-i18n="loading.subscription">Loading subscription options...</span>
                    </div>
                </div>
            </section>

            <!-- Payment Methods -->
            <section class="expandable-section" id="paymentSection">
                <button class="section-header" data-section="payment">
                    <div class="section-title">
                        <span class="section-icon">üí∞</span>
                        <span data-i18n="payment.title">Payment & Balance</span>
                    </div>
                    <svg class="expand-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5"/>
                    </svg>
                </button>
                <div class="section-content" id="paymentContent">
                    <div class="loading-section">
                        <div class="loading-spinner"></div>
                        <span data-i18n="loading.payment">Loading payment methods...</span>
                    </div>
                </div>
            </section>

            <!-- Devices & Servers -->
            <section class="expandable-section" id="devicesSection">
                <button class="section-header" data-section="devices">
                    <div class="section-title">
                        <span class="section-icon">üì±</span>
                        <span data-i18n="devices.title">Devices & Servers</span>
                    </div>
                    <svg class="expand-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5"/>
                    </svg>
                </button>
                <div class="section-content" id="devicesContent">
                    <div class="loading-section">
                        <div class="loading-spinner"></div>
                        <span data-i18n="loading.devices">Loading devices and servers...</span>
                    </div>
                </div>
            </section>

            <!-- Promo & Referrals -->
            <section class="expandable-section" id="promoSection">
                <button class="section-header" data-section="promo">
                    <div class="section-title">
                        <span class="section-icon">üéÅ</span>
                        <span data-i18n="promo.title">Promotions</span>
                    </div>
                    <svg class="expand-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5"/>
                    </svg>
                </button>
                <div class="section-content" id="promoContent">
                    <div class="loading-section">
                        <div class="loading-spinner"></div>
                        <span data-i18n="loading.promo">Loading promotions...</span>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-backdrop hidden" id="modalBackdrop">
        <div class="modal" id="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle"></h3>
                <button class="modal-close" id="modalClose" aria-label="Close">
                    <svg viewBox="0 0 24 24">
                        <path d="M18 6L6 18m12 0L6 6"/>
                    </svg>
                </button>
            </div>
            <div class="modal-content" id="modalContent"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab hidden" id="connectFab">
        <svg class="fab-icon" viewBox="0 0 24 24">
            <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
        <span class="fab-text" data-i18n="fab.connect">Connect</span>
    </button>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Telegram Web App Integration
        const tg = window.Telegram?.WebApp || {
            initData: '',
            initDataUnsafe: {},
            expand: () => {},
            ready: () => {},
            themeParams: {},
            showPopup: null,
            onEvent: () => {},
            offEvent: () => {},
        };

        // Initialize Telegram WebApp
        if (typeof tg.expand === 'function') tg.expand();
        if (typeof tg.ready === 'function') tg.ready();

        // Global State
        let appState = {
            user: null,
            subscription: null,
            balance: 0,
            currency: 'RUB',
            language: 'en',
            theme: 'light',
            expandedSections: new Set(),
        };

        // Translations
        const translations = {
            en: {
                'app.name': 'SecureVPN',
                'app.subtitle': 'Fast & Secure Connection',
                'app.loading': 'Loading...',
                'error.title': 'Something went wrong',
                'error.message': 'Please try again later',
                'error.retry': 'Retry',
                'status.active': 'Active',
                'status.expired': 'Expired',
                'status.trial': 'Trial',
                'stats.days_left': 'Days Left',
                'stats.servers': 'Servers',
                'stats.devices': 'Devices',
                'stats.balance': 'Balance',
                'actions.connect': 'Connect VPN',
                'actions.renew': 'Renew',
                'actions.topup': 'Top Up',
                'actions.settings': 'Settings',
                'subscription.title': 'Subscription',
                'payment.title': 'Payment & Balance',
                'devices.title': 'Devices & Servers',
                'promo.title': 'Promotions',
                'fab.connect': 'Connect',
                'loading.subscription': 'Loading subscription options...',
                'loading.payment': 'Loading payment methods...',
                'loading.devices': 'Loading devices and servers...',
                'loading.promo': 'Loading promotions...',
                'subscription.renew': 'Renew Subscription',
                'subscription.upgrade': 'Upgrade Plan',
                'subscription.expires': 'Expires',
                'subscription.autopay': 'Auto-pay',
                'subscription.autopay.enabled': 'Enabled',
                'subscription.autopay.disabled': 'Disabled',
                'payment.methods.title': 'Payment Methods',
                'payment.balance.title': 'Current Balance',
                'payment.topup.title': 'Top Up Balance',
                'payment.method.card': 'Bank Card',
                'payment.method.stars': 'Telegram Stars',
                'payment.method.crypto': 'Cryptocurrency',
                'payment.method.sbp': 'Fast Payment System',
                'devices.connected': 'Connected Devices',
                'devices.servers': 'Available Servers',
                'devices.remove': 'Remove',
                'servers.connect': 'Connect',
                'servers.disconnect': 'Disconnect',
                'promo.codes': 'Promo Codes',
                'promo.referral': 'Referral Program',
                'promo.offers': 'Special Offers',
                'modal.close': 'Close',
                'modal.cancel': 'Cancel',
                'modal.confirm': 'Confirm',
                'toast.success': 'Success',
                'toast.error': 'Error',
                'toast.warning': 'Warning',
                'toast.info': 'Info',
            },
            ru: {
                'app.name': 'SecureVPN',
                'app.subtitle': '–ë—ã—Å—Ç—Ä–æ–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ',
                'app.loading': '–ó–∞–≥—Ä—É–∑–∫–∞...',
                'error.title': '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫',
                'error.message': '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –ø–æ–∑–∂–µ',
                'error.retry': '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å',
                'status.active': '–ê–∫—Ç–∏–≤–Ω–∞',
                'status.expired': '–ò—Å—Ç–µ–∫–ª–∞',
                'status.trial': '–ü—Ä–æ–±–Ω–∞—è',
                'stats.days_left': '–î–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å',
                'stats.servers': '–°–µ—Ä–≤–µ—Ä—ã',
                'stats.devices': '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',
                'stats.balance': '–ë–∞–ª–∞–Ω—Å',
                'actions.connect': '–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è',
                'actions.renew': '–ü—Ä–æ–¥–ª–∏—Ç—å',
                'actions.topup': '–ü–æ–ø–æ–ª–Ω–∏—Ç—å',
                'actions.settings': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
                'subscription.title': '–ü–æ–¥–ø–∏—Å–∫–∞',
                'payment.title': '–ü–ª–∞—Ç–µ–∂–∏ –∏ –±–∞–ª–∞–Ω—Å',
                'devices.title': '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ —Å–µ—Ä–≤–µ—Ä—ã',
                'promo.title': '–ê–∫—Ü–∏–∏',
                'fab.connect': '–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è',
                'loading.subscription': '–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–ø–∏—Å–∫–∏...',
                'loading.payment': '–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã...',
                'loading.devices': '–ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ —Å–µ—Ä–≤–µ—Ä—ã...',
                'loading.promo': '–ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ü–∏–∏...',
                'subscription.renew': '–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É',
                'subscription.upgrade': '–£–ª—É—á—à–∏—Ç—å —Ç–∞—Ä–∏—Ñ',
                'subscription.expires': '–ò—Å—Ç–µ–∫–∞–µ—Ç',
                'subscription.autopay': '–ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂',
                'subscription.autopay.enabled': '–í–∫–ª—é—á–µ–Ω',
                'subscription.autopay.disabled': '–í—ã–∫–ª—é—á–µ–Ω',
                'payment.methods.title': '–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã',
                'payment.balance.title': '–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å',
                'payment.topup.title': '–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å',
                'payment.method.card': '–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞',
                'payment.method.stars': '–ó–≤—ë–∑–¥—ã Telegram',
                'payment.method.crypto': '–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞',
                'payment.method.sbp': '–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π',
                'devices.connected': '–ü–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',
                'devices.servers': '–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã',
                'devices.remove': '–£–¥–∞–ª–∏—Ç—å',
                'servers.connect': '–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è',
                'servers.disconnect': '–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è',
                'promo.codes': '–ü—Ä–æ–º–æ–∫–æ–¥—ã',
                'promo.referral': '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞',
                'promo.offers': '–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è',
                'modal.close': '–ó–∞–∫—Ä—ã—Ç—å',
                'modal.cancel': '–û—Ç–º–µ–Ω–∞',
                'modal.confirm': '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å',
                'toast.success': '–£—Å–ø–µ—à–Ω–æ',
                'toast.error': '–û—à–∏–±–∫–∞',
                'toast.warning': '–í–Ω–∏–º–∞–Ω–∏–µ',
                'toast.info': '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
            }
        };

        // Utility Functions
        function t(key) {
            const currentLang = appState.language || 'en';
            return translations[currentLang]?.[key] || translations.en[key] || key;
        }

        function formatCurrency(amount, currency = 'RUB') {
            try {
                return new Intl.NumberFormat(appState.language, {
                    style: 'currency',
                    currency: currency,
                }).format(amount);
            } catch {
                return `${amount} ${currency}`;
            }
        }

        function formatDate(date) {
            if (!date) return '‚Äî';
            try {
                return new Date(date).toLocaleDateString(appState.language);
            } catch {
                return '‚Äî';
            }
        }

        function showToast(message, type = 'info', title = '') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const toastTitle = title || t(`toast.${type}`);
            toast.innerHTML = `
                <div class="toast-title">${toastTitle}</div>
                <div class="toast-message">${message}</div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }

        function showModal(title, content, footer = '') {
            const backdrop = document.getElementById('modalBackdrop');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const modalFooter = document.getElementById('modalFooter');
            
            modalTitle.textContent = title;
            modalContent.innerHTML = content;
            modalFooter.innerHTML = footer;
            
            backdrop.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function hideModal() {
            const backdrop = document.getElementById('modalBackdrop');
            backdrop.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // API Functions
        async function apiRequest(endpoint, options = {}) {
            const baseUrl = '/miniapp';
            const url = `${baseUrl}${endpoint}`;
            
            const defaultOptions = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    initData: tg.initData || '',
                    ...options.data
                })
            };
            
            try {
                const response = await fetch(url, { ...defaultOptions, ...options });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                throw error;
            }
        }

        async function loadUserData() {
            try {
                const data = await apiRequest('/subscription');
                appState.user = data.user;
                appState.subscription = data.subscription;
                appState.balance = data.balance || 0;
                appState.currency = data.currency || 'RUB';
                return data;
            } catch (error) {
                console.error('Failed to load user data:', error);
                throw error;
            }
        }

        async function loadPaymentMethods() {
            try {
                return await apiRequest('/payments/methods');
            } catch (error) {
                console.error('Failed to load payment methods:', error);
                return { methods: [] };
            }
        }

        async function loadDevices() {
            try {
                return await apiRequest('/devices');
            } catch (error) {
                console.error('Failed to load devices:', error);
                return { devices: [], servers: [] };
            }
        }

        async function loadSubscriptionOptions() {
            try {
                return await apiRequest('/subscription/options');
            } catch (error) {
                console.error('Failed to load subscription options:', error);
                return { options: [] };
            }
        }

        async function loadPromoData() {
            try {
                return await apiRequest('/promo');
            } catch (error) {
                console.error('Failed to load promo data:', error);
                return { codes: [], referral: {}, offers: [] };
            }
        }

        // UI Update Functions
        function updateUserInfo() {
            const { user, subscription } = appState;
            if (!user) return;
            
            // Update user avatar and name
            const avatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const statusBadge = document.getElementById('statusBadge');
            
            avatar.textContent = user.name?.charAt(0)?.toUpperCase() || 'U';
            userName.textContent = user.name || 'User';
            
            // Update status
            const status = subscription?.status || 'expired';
            statusBadge.className = `status-badge ${status}`;
            statusBadge.textContent = t(`status.${status}`);
            
            // Update stats
            document.getElementById('daysLeft').textContent = subscription?.daysLeft || '‚Äî';
            document.getElementById('serversCount').textContent = subscription?.serversCount || '‚Äî';
            document.getElementById('devicesCount').textContent = subscription?.devicesCount || '‚Äî';
            document.getElementById('balanceAmount').textContent = formatCurrency(appState.balance, appState.currency);
        }

        function renderSubscriptionContent() {
            const content = document.getElementById('subscriptionContent');
            const { subscription } = appState;
            
            if (!subscription) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div class="empty-state-title">${t('subscription.no_subscription')}</div>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = `
                <div class="subscription-option">
                    <div class="subscription-info">
                        <div class="subscription-title">${subscription.plan || 'Current Plan'}</div>
                        <div class="subscription-description">${t('subscription.expires')}: ${formatDate(subscription.expiresAt)}</div>
                        <div class="subscription-description">${t('subscription.autopay')}: ${subscription.autopay ? t('subscription.autopay.enabled') : t('subscription.autopay.disabled')}</div>
                    </div>
                    <div class="subscription-actions">
                        <button class="btn btn-primary" onclick="handleRenewSubscription()">${t('subscription.renew')}</button>
                    </div>
                </div>
                <div class="subscription-settings">
                    <div class="stepper">
                        <button class="stepper-button" onclick="adjustDevices(-1)">‚àí</button>
                        <div class="stepper-value">${subscription.maxDevices || 1}</div>
                        <button class="stepper-button" onclick="adjustDevices(1)">+</button>
                        <div class="stepper-label">${t('stats.devices')}</div>
                    </div>
                </div>
            `;
        }

        function renderPaymentContent() {
            const content = document.getElementById('paymentContent');
            
            content.innerHTML = `
                <div class="payment-balance">
                    <h4>${t('payment.balance.title')}</h4>
                    <div class="balance-display">
                        <span class="balance-amount">${formatCurrency(appState.balance, appState.currency)}</span>
                        <button class="btn btn-primary" onclick="handleTopUp()">${t('actions.topup')}</button>
                    </div>
                </div>
                <div class="payment-methods">
                    <h4>${t('payment.methods.title')}</h4>
                    <div class="payment-method" onclick="handlePaymentMethod('card')">
                        <div class="payment-method-icon">üí≥</div>
                        <div class="payment-method-info">
                            <div class="payment-method-name">${t('payment.method.card')}</div>
                            <div class="payment-method-description">Visa, MasterCard, –ú–ò–†</div>
                        </div>
                    </div>
                    <div class="payment-method" onclick="handlePaymentMethod('stars')">
                        <div class="payment-method-icon">‚≠ê</div>
                        <div class="payment-method-info">
                            <div class="payment-method-name">${t('payment.method.stars')}</div>
                            <div class="payment-method-description">Pay with Telegram Stars</div>
                        </div>
                    </div>
                    <div class="payment-method" onclick="handlePaymentMethod('crypto')">
                        <div class="payment-method-icon">‚Çø</div>
                        <div class="payment-method-info">
                            <div class="payment-method-name">${t('payment.method.crypto')}</div>
                            <div class="payment-method-description">BTC, ETH, USDT</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDevicesContent() {
            const content = document.getElementById('devicesContent');
            
            // Mock data for demonstration
            const devices = [
                { id: 1, name: 'iPhone 15 Pro', type: 'mobile', os: 'iOS 17.1', lastSeen: '2 min ago' },
                { id: 2, name: 'MacBook Pro', type: 'desktop', os: 'macOS 14.1', lastSeen: '1 hour ago' },
            ];
            
            const servers = [
                { id: 1, name: 'Netherlands', flag: 'üá≥üá±', location: 'Amsterdam', connected: true },
                { id: 2, name: 'Germany', flag: 'üá©üá™', location: 'Frankfurt', connected: false },
                { id: 3, name: 'United States', flag: 'üá∫üá∏', location: 'New York', connected: false },
                { id: 4, name: 'Singapore', flag: 'üá∏üá¨', location: 'Singapore', connected: false },
            ];
            
            content.innerHTML = `
                <div class="devices-servers">
                    <div class="devices-section">
                        <h4>${t('devices.connected')}</h4>
                        <div class="device-list">
                            ${devices.map(device => `
                                <div class="device-item">
                                    <div class="device-info">
                                        <div class="device-icon">${device.type === 'mobile' ? 'üì±' : 'üíª'}</div>
                                        <div class="device-details">
                                            <div class="device-name">${device.name}</div>
                                            <div class="device-meta">${device.os} ‚Ä¢ ${device.lastSeen}</div>
                                        </div>
                                    </div>
                                    <button class="device-action" onclick="handleRemoveDevice(${device.id})">${t('devices.remove')}</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="servers-section">
                        <h4>${t('devices.servers')}</h4>
                        <div class="server-list">
                            ${servers.map(server => `
                                <div class="server-item ${server.connected ? 'connected' : ''}" onclick="handleServerToggle(${server.id})">
                                    <div class="server-flag">${server.flag}</div>
                                    <div class="server-info">
                                        <div class="server-name">${server.name}</div>
                                        <div class="server-location">${server.location}</div>
                                        <div class="server-status">${server.connected ? t('servers.disconnect') : t('servers.connect')}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPromoContent() {
            const content = document.getElementById('promoContent');
            
            content.innerHTML = `
                <div class="promo-sections">
                    <div class="promo-codes-section">
                        <h4>${t('promo.codes')}</h4>
                        <div class="promo-code-input">
                            <input type="text" class="form-input" placeholder="Enter promo code" id="promoCodeInput">
                            <button class="btn btn-primary" onclick="handlePromoCode()">${t('modal.confirm')}</button>
                        </div>
                    </div>
                    <div class="referral-section">
                        <h4>${t('promo.referral')}</h4>
                        <div class="referral-info">
                            <p>Share your referral link and earn rewards!</p>
                            <div class="referral-stats">
                                <div class="stat-item">
                                    <div class="stat-value">0</div>
                                    <div class="stat-label">Invited</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${formatCurrency(0, appState.currency)}</div>
                                    <div class="stat-label">Earned</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPromoOffers() {
            const container = document.getElementById('promoOffers');
            
            // Mock promo offer
            const hasOffers = Math.random() > 0.5;
            
            if (!hasOffers) {
                container.classList.add('hidden');
                return;
            }
            
            container.innerHTML = `
                <div class="promo-offer">
                    <div class="promo-offer-content">
                        <div class="promo-offer-title">üéâ Special Offer!</div>
                        <div class="promo-offer-description">Get 50% off on your next subscription renewal. Limited time only!</div>
                        <button class="promo-offer-action" onclick="handlePromoOffer()">Claim Offer</button>
                    </div>
                </div>
            `;
            container.classList.remove('hidden');
        }

        // Event Handlers
        function handleConnect() {
            showToast('Connecting to VPN...', 'info');
            // Simulate connection process
            setTimeout(() => {
                showToast('Successfully connected!', 'success');
            }, 2000);
        }

        function handleRenewSubscription() {
            showModal(
                t('subscription.renew'),
                `
                    <div class="subscription-options">
                        <div class="subscription-option" onclick="selectSubscription('monthly')">
                            <div class="subscription-info">
                                <div class="subscription-title">Monthly Plan</div>
                                <div class="subscription-description">Full access for 1 month</div>
                            </div>
                            <div class="subscription-price">
                                ${formatCurrency(299, appState.currency)}
                                <div class="subscription-price-period">/month</div>
                            </div>
                        </div>
                        <div class="subscription-option" onclick="selectSubscription('yearly')">
                            <div class="subscription-info">
                                <div class="subscription-title">Yearly Plan</div>
                                <div class="subscription-description">Full access for 12 months</div>
                            </div>
                            <div class="subscription-price">
                                ${formatCurrency(2399, appState.currency)}
                                <div class="subscription-price-period">/year</div>
                            </div>
                        </div>
                    </div>
                `,
                `<button class="btn btn-secondary" onclick="hideModal()">${t('modal.cancel')}</button>`
            );
        }

        function handleTopUp() {
            showModal(
                t('payment.topup.title'),
                `
                    <div class="topup-form">
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <input type="number" class="form-input" placeholder="Enter amount" id="topupAmount">
                        </div>
                        <div class="payment-methods">
                            <div class="payment-method" onclick="selectPaymentMethod('card')">
                                <div class="payment-method-icon">üí≥</div>
                                <div class="payment-method-info">
                                    <div class="payment-method-name">${t('payment.method.card')}</div>
                                </div>
                            </div>
                            <div class="payment-method" onclick="selectPaymentMethod('stars')">
                                <div class="payment-method-icon">‚≠ê</div>
                                <div class="payment-method-info">
                                    <div class="payment-method-name">${t('payment.method.stars')}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                `
                    <button class="btn btn-secondary" onclick="hideModal()">${t('modal.cancel')}</button>
                    <button class="btn btn-primary" onclick="processTopUp()">${t('modal.confirm')}</button>
                `
            );
        }

        function handlePromoCode() {
            const input = document.getElementById('promoCodeInput');
            const code = input.value.trim();
            
            if (!code) {
                showToast('Please enter a promo code', 'warning');
                return;
            }
            
            // Mock promo code activation
            showToast('Promo code activated! +100 RUB added to your balance.', 'success');
            appState.balance += 100;
            updateUserInfo();
            input.value = '';
        }

        function handleRemoveDevice(deviceId) {
            if (confirm('Remove this device?')) {
                showToast('Device removed successfully', 'success');
                // Refresh devices content
                renderDevicesContent();
            }
        }

        function handleServerToggle(serverId) {
            showToast('Server connection toggled', 'info');
            // Refresh servers content
            renderDevicesContent();
        }

        function handlePromoOffer() {
            showToast('Promo offer claimed!', 'success');
            document.getElementById('promoOffers').classList.add('hidden');
        }

        function selectSubscription(plan) {
            showToast(`${plan} plan selected`, 'info');
            hideModal();
        }

        function selectPaymentMethod(method) {
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        function processTopUp() {
            const amount = document.getElementById('topupAmount').value;
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'warning');
                return;
            }
            
            hideModal();
            showToast('Payment processed successfully!', 'success');
            appState.balance += parseFloat(amount);
            updateUserInfo();
        }

        function adjustDevices(delta) {
            const currentDevices = appState.subscription?.maxDevices || 1;
            const newDevices = Math.max(1, Math.min(10, currentDevices + delta));
            
            if (newDevices !== currentDevices) {
                appState.subscription.maxDevices = newDevices;
                renderSubscriptionContent();
                showToast(`Device limit updated to ${newDevices}`, 'info');
            }
        }

        // Section Toggle Handler
        function toggleSection(sectionName) {
            const section = document.getElementById(`${sectionName}Section`);
            const content = document.getElementById(`${sectionName}Content`);
            
            if (appState.expandedSections.has(sectionName)) {
                // Collapse
                appState.expandedSections.delete(sectionName);
                section.classList.remove('expanded');
            } else {
                // Expand
                appState.expandedSections.add(sectionName);
                section.classList.add('expanded');
                
                // Load content if needed
                if (content.innerHTML.includes('loading-section')) {
                    loadSectionContent(sectionName);
                }
            }
        }

        async function loadSectionContent(sectionName) {
            const content = document.getElementById(`${sectionName}Content`);
            
            try {
                switch (sectionName) {
                    case 'subscription':
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate loading
                        renderSubscriptionContent();
                        break;
                    case 'payment':
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        renderPaymentContent();
                        break;
                    case 'devices':
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        renderDevicesContent();
                        break;
                    case 'promo':
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        renderPromoContent();
                        break;
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-title">Failed to load content</div>
                        <button class="btn btn-primary" onclick="loadSectionContent('${sectionName}')">Try Again</button>
                    </div>
                `;
            }
        }

        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const telegramTheme = tg.themeParams?.bg_color ? 
                (tg.themeParams.bg_color === '#ffffff' ? 'light' : 'dark') : 
                savedTheme;
            
            appState.theme = telegramTheme;
            applyTheme(appState.theme);
        }

        function toggleTheme() {
            appState.theme = appState.theme === 'light' ? 'dark' : 'light';
            applyTheme(appState.theme);
            localStorage.setItem('theme', appState.theme);
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            
            const sunIcon = document.querySelector('.sun-icon');
            const moonIcon = document.querySelector('.moon-icon');
            
            if (theme === 'dark') {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        }

        // Language Management
        function initLanguage() {
            const savedLang = localStorage.getItem('language') || 'en';
            const telegramLang = tg.initDataUnsafe?.user?.language_code || savedLang;
            const supportedLang = ['en', 'ru'].includes(telegramLang) ? telegramLang : 'en';
            
            appState.language = supportedLang;
            applyLanguage(appState.language);
        }

        function changeLanguage() {
            const select = document.getElementById('languageSelect');
            appState.language = select.value;
            applyLanguage(appState.language);
            localStorage.setItem('language', appState.language);
        }

        function applyLanguage(lang) {
            document.documentElement.setAttribute('lang', lang);
            document.getElementById('languageSelect').value = lang;
            
            // Update all translatable elements
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = t(key);
            });
            
            // Update dynamic content if already loaded
            if (appState.user) {
                updateUserInfo();
            }
        }

        // Error Handling
        function showError(message) {
            const loadingScreen = document.getElementById('loadingScreen');
            const errorState = document.getElementById('errorState');
            const mainContent = document.getElementById('mainContent');
            
            loadingScreen.classList.add('hidden');
            mainContent.classList.add('hidden');
            errorState.classList.remove('hidden');
            
            const errorMessage = document.querySelector('.error-message');
            errorMessage.textContent = message;
        }

        function hideError() {
            document.getElementById('errorState').classList.add('hidden');
        }

        // App Initialization
        async function initApp() {
            try {
                // Initialize theme and language
                initTheme();
                initLanguage();
                
                // Apply Telegram theme parameters
                if (tg.themeParams) {
                    Object.entries(tg.themeParams).forEach(([key, value]) => {
                        document.documentElement.style.setProperty(`--tg-theme-${key.replace(/_/g, '-')}`, value);
                    });
                }
                
                // Load user data
                await loadUserData();
                
                // Update UI
                updateUserInfo();
                renderPromoOffers();
                
                // Show main content
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                
                // Show FAB if subscription is active
                if (appState.subscription?.status === 'active') {
                    document.getElementById('connectFab').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('App initialization failed:', error);
                showError(t('error.message'));
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Language selector
            document.getElementById('languageSelect').addEventListener('change', changeLanguage);
            
            // Quick action buttons
            document.getElementById('connectBtn').addEventListener('click', handleConnect);
            document.getElementById('renewBtn').addEventListener('click', handleRenewSubscription);
            document.getElementById('topupBtn').addEventListener('click', handleTopUp);
            document.getElementById('settingsBtn').addEventListener('click', () => {
                showToast('Settings coming soon!', 'info');
            });
            
            // FAB
            document.getElementById('connectFab').addEventListener('click', handleConnect);
            
            // Modal close
            document.getElementById('modalClose').addEventListener('click', hideModal);
            document.getElementById('modalBackdrop').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) hideModal();
            });
            
            // Section toggles
            document.querySelectorAll('.section-header').forEach(header => {
                header.addEventListener('click', () => {
                    const sectionName = header.getAttribute('data-section');
                    toggleSection(sectionName);
                });
            });
            
            // Error retry
            document.getElementById('retryButton').addEventListener('click', () => {
                hideError();
                document.getElementById('loadingScreen').classList.remove('hidden');
                initApp();
            });
            
            // Initialize app
            initApp();
        });

        // Telegram WebApp event handlers
        if (typeof tg.onEvent === 'function') {
            tg.onEvent('themeChanged', () => {
                const newTheme = tg.themeParams?.bg_color === '#ffffff' ? 'light' : 'dark';
                if (newTheme !== appState.theme) {
                    appState.theme = newTheme;
                    applyTheme(appState.theme);
                }
            });
        }

        // Export global functions for inline event handlers
        window.handleConnect = handleConnect;
        window.handleRenewSubscription = handleRenewSubscription;
        window.handleTopUp = handleTopUp;
        window.handlePromoCode = handlePromoCode;
        window.handleRemoveDevice = handleRemoveDevice;
        window.handleServerToggle = handleServerToggle;
        window.handlePromoOffer = handlePromoOffer;
        window.selectSubscription = selectSubscription;
        window.selectPaymentMethod = selectPaymentMethod;
        window.processTopUp = processTopUp;
        window.adjustDevices = adjustDevices;
        window.loadSectionContent = loadSectionContent;
        window.hideModal = hideModal;
        window.toggleSection = toggleSection;
    </script>
</body>
</html>