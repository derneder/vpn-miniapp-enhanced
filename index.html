<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="theme-color" content="#7C3AED" />
<title>Remnawave MiniApp</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* ====== Purple theme (light/dark) ====== */
:root {
  --primary: #7c3aed;       /* violet-600 */
  --primary-700: #6d28d9;   /* violet-700 */
  --primary-200: #e9d5ff;   /* violet-200 */
  --bg: #ffffff;
  --bg-2: #f3f4f6;
  --text: #0f172a;
  --muted: #6b7280;
  --success: #10b981;
  --warn: #f59e0b;
  --danger: #ef4444;
  --card: #ffffff;
  --border: rgba(15,23,42,.08);
  --shadow: 0 8px 24px rgba(2,6,23,.08);
}
:root[data-theme="dark"] {
  --bg: #0f172a;
  --bg-2: #111827;
  --text: #e5e7eb;
  --muted: #94a3b8;
  --card: #111827;
  --border: rgba(255,255,255,.12);
  --shadow: 0 10px 28px rgba(0,0,0,.45);
}
/* Base */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
.hidden{display:none!important}
.container{max-width:640px;margin:0 auto;padding:12px 12px 80px}
.header{padding:12px 8px 24px;position:sticky;top:0;background:linear-gradient(180deg, rgba(124,58,237,.12), transparent);backdrop-filter:saturate(140%) blur(4px);z-index:10}
.row{display:flex;gap:10px;align-items:center;justify-content:space-between}
.select, .icon-btn{border:2px solid var(--border);background:var(--card);color:var(--text);border-radius:12px;padding:8px 12px;font-weight:600}
.icon-btn{display:flex;align-items:center;gap:8px;cursor:pointer}
.icon{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2}
.title{font-size:22px;font-weight:800;margin:12px 0 4px;background:linear-gradient(135deg,var(--primary),var(--primary-700));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sub{color:var(--muted);font-size:13px}
/* Tabs */
.tabs{display:flex;gap:8px;overflow:auto;padding-bottom:8px;margin:8px 0}
.tab{flex:0 0 auto;border:2px solid var(--border);background:var(--card);padding:10px 14px;border-radius:999px;font-weight:700;cursor:pointer;color:var(--muted)}
.tab.active{border-color:var(--primary);color:var(--primary);background:linear-gradient(135deg,rgba(124,58,237,.12),rgba(124,58,237,.04))}
.section{margin-top:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px;margin:10px 0}
.hdr{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
.h5{font-weight:800}
.muted{color:var(--muted)}
.grid{display:grid;gap:10px}
@media(min-width:480px){.grid-2{grid-template-columns:repeat(2,1fr)}.grid-3{grid-template-columns:repeat(3,1fr)}}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border:none;border-radius:12px;cursor:pointer;font-weight:800}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-700));color:#fff}
.btn-outline{background:transparent;border:2px solid var(--primary);color:var(--primary)}
.btn-ghost{background:transparent;color:var(--primary)}
.input{width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--border);background:var(--card);color:var(--text);font-weight:600}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
.badge-green{background:rgba(16,185,129,.15);color:var(--success)}
.badge-red{background:rgba(239,68,68,.15);color:var(--danger)}
.badge-violet{background:rgba(124,58,237,.15);color:var(--primary)}
.row-wrap{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.kbd{padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:var(--bg-2);font-size:12px}
.toast{position:fixed;right:12px;bottom:12px;left:12px;z-index:50}
.toast .msg{margin:6px auto;max-width:640px;background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow);padding:12px 14px;border-radius:12px}
/* Quick skeleton */
.skel{background:linear-gradient(90deg,transparent, rgba(124,58,237,.14), transparent);border-radius:10px;height:12px}
</style>
</head>
<body>
<div class="header">
  <div class="row">
    <select id="lang" class="select" aria-label="Language">
      <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
      <option value="en">üá¨üáß English</option>
    </select>
    <button id="theme" class="icon-btn" aria-label="Theme">
      <svg class="icon" viewBox="0 0 24 24"><path d="M12 3v2m0 14v2M4.2 4.2l1.4 1.4m12.8 12.8l1.4 1.4M3 12h2m14 0h2M4.2 19.8l1.4-1.4m12.8-12.8l1.4-1.4"/></svg>
      <span id="themeLabel">Light</span>
    </button>
  </div>
  <div class="title" id="title">Remnawave</div>
  <div class="sub" id="subtitle">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç Mini App</div>
  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="connect" id="tab-connect">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
    <button class="tab" data-tab="plan" id="tab-plan">–ü–æ–¥–ø–∏—Å–∫–∞ / –ë–∞–ª–∞–Ω—Å</button>
    <button class="tab" data-tab="ref" id="tab-ref">–†–µ—Ñ–µ—Ä–∞–ª—ã</button>
    <button class="tab" data-tab="devices" id="tab-devices">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ —Å–µ—Ä–≤–µ—Ä—ã</button>
    <button class="tab" data-tab="settings" id="tab-settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <button class="tab" data-tab="help" id="tab-help">–°–ø—Ä–∞–≤–∫–∞</button>
  </div>
</div>
<div class="container">
  <!-- CONNECT -->
  <section id="sec-connect" class="section">
    <div class="card">
      <div class="hdr"><div class="h5" id="h_connect_quick">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∑–∞ 30 —Å–µ–∫</div><span class="badge badge-violet" id="badge_recommended">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º</span></div>
      <div class="grid grid-2">
        <div>
          <div class="muted" id="p_connect_pick">1) –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É</div>
          <div class="row-wrap" style="margin-top:8px">
            <button class="btn btn-outline" data-platform="ios">üçé iOS</button>
            <button class="btn btn-outline" data-platform="android">ü§ñ Android</button>
            <button class="btn btn-outline" data-platform="pc">üíª PC</button>
            <button class="btn btn-outline" data-platform="tv">üì∫ TV</button>
          </div>
        </div>
        <div>
          <div class="muted" id="p_connect_copy">2) –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –ø–æ–¥–ø–∏—Å–∫–∏</div>
          <div class="row" style="margin-top:8px">
            <input id="subLink" class="input" readonly value="" />
            <button id="copySub" class="btn btn-primary">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="openClient" class="btn btn-primary">–û—Ç–∫—Ä—ã—Ç—å –∫–ª–∏–µ–Ω—Ç</button>
        <button id="testConnect" class="btn btn-ghost">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
      </div>
    </div>
    <div class="card">
      <div class="hdr"><div class="h5" id="h_servers">–°–µ—Ä–≤–µ—Ä—ã</div><span class="muted" id="serversSummary">‚Äî</span></div>
      <div id="servers" class="grid grid-2"></div>
    </div>
  </section>
  
  <!-- PLAN/BALANCE -->
  <section id="sec-plan" class="section hidden">
    <div class="card">
      <div class="hdr"><div class="h5" id="h_subscription">–ü–æ–¥–ø–∏—Å–∫–∞</div><span class="badge badge-green" id="subStatus">‚Äî</span></div>
      <div class="grid grid-2">
        <div>
          <div class="muted" id="lbl_period">–ü–µ—Ä–∏–æ–¥</div>
          <div id="periods" class="row-wrap" style="margin-top:8px"></div>
        </div>
        <div>
          <div class="muted" id="lbl_traffic">–¢—Ä–∞—Ñ–∏–∫</div>
          <div id="traffic" class="row-wrap" style="margin-top:8px"></div>
        </div>
        <div>
          <div class="muted" id="lbl_devices">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div>
          <div class="row" style="margin-top:8px">
            <button class="btn btn-outline" id="devMinus">‚àí</button>
            <div class="kbd" id="devValue">1</div>
            <button class="btn btn-outline" id="devPlus">+</button>
          </div>
        </div>
        <div>
          <div class="muted" id="lbl_servers">–°–µ—Ä–≤–µ—Ä—ã</div>
          <div id="srvPick" class="row-wrap" style="margin-top:8px"></div>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="hdr"><div class="h5" id="h_total">–ò—Ç–æ–≥–æ</div></div>
        <div class="row" style="justify-content:space-between">
          <div>
            <div id="priceCurrent" class="h5">‚Äî</div>
            <div class="muted" id="pricePerMonth">‚Äî</div>
          </div>
          <div class="row-wrap">
            <span id="discountBadge" class="badge badge-violet hidden"></span>
            <button id="btnBuy" class="btn btn-primary">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="hdr"><div class="h5" id="h_balance">–ë–∞–ª–∞–Ω—Å</div><span class="muted" id="balanceVal">‚Äî</span></div>
      <div class="muted" id="p_fast_topup">–ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
      <div class="row-wrap" style="margin-top:8px">
        <button class="btn btn-outline preset" data-amount="300">+300</button>
        <button class="btn btn-outline preset" data-amount="500">+500</button>
        <button class="btn btn-outline preset" data-amount="1000">+1000</button>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="topupAmount" class="input" placeholder="–°—É–º–º–∞" />
        <button id="topupBtn" class="btn btn-primary">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
      </div>
      <div class="row-wrap" style="margin-top:10px" id="payMethods"></div>
    </div>
  </section>

  <!-- REFERRALS -->
  <section id="sec-ref" class="section hidden">
    <div class="card">
      <div class="hdr"><div class="h5" id="h_ref">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</div></div>
      <div class="row">
        <input id="refLink" class="input" readonly value="" />
        <button id="copyRef" class="btn btn-primary">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <div class="grid grid-3" style="margin-top:10px">
        <div class="card"><div class="muted">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div><div id="refInvited" class="h5">0</div></div>
        <div class="card"><div class="muted">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div><div id="refActive" class="h5">0</div></div>
        <div class="card"><div class="muted">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div><div id="refEarned" class="h5">‚Äî</div></div>
      </div>
    </div>
  </section>

  <!-- DEVICES & SERVERS -->
  <section id="sec-devices" class="section hidden">
    <div class="card">
      <div class="hdr"><div class="h5">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div></div>
      <div id="devices" class="grid"></div>
    </div>
    <div class="card">
      <div class="hdr"><div class="h5">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã</div></div>
      <div id="allServers" class="grid grid-2"></div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="sec-settings" class="section hidden">
    <div class="card">
      <div class="hdr"><div class="h5">–ê–≤—Ç–æ–ø–ª–∞—Ç—ë–∂</div><span id="autopayState" class="badge">‚Äî</span></div>
      <div class="row-wrap">
        <button class="btn btn-outline" data-autopay="enable">–í–∫–ª—é—á–∏—Ç—å</button>
        <button class="btn btn-outline" data-autopay="disable">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
        <button class="btn btn-outline" data-day="same">–í –¥–µ–Ω—å —Å–ø–∏—Å–∞–Ω–∏—è</button>
        <button class="btn btn-outline" data-day="1">–ó–∞ 1 –¥–µ–Ω—å</button>
        <button class="btn btn-outline" data-day="3">–ó–∞ 3 –¥–Ω—è</button>
      </div>
    </div>
    <div class="card">
      <div class="hdr"><div class="h5">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</div></div>
      <div class="row-wrap">
        <button id="toRu" class="btn btn-outline">RU</button>
        <button id="toEn" class="btn btn-outline">EN</button>
        <button id="toggleTheme" class="btn btn-outline">Light/Dark</button>
      </div>
    </div>
    <div class="card">
      <div class="hdr"><div class="h5">–î–æ–∫—É–º–µ–Ω—Ç—ã</div></div>
      <div class="row-wrap">
        <a class="btn btn-ghost" href="#" id="offer">–ü—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞</a>
        <a class="btn btn-ghost" href="#" id="policy">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
      </div>
    </div>
  </section>

  <!-- HELP -->
  <section id="sec-help" class="section hidden">
    <div class="card">
      <div class="hdr"><div class="h5">FAQ</div></div>
      <div class="grid">
        <div class="card"><div class="h5">–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è?</div><div class="muted">–û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É ¬´–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ¬ª, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –∫–ª–∏–µ–Ω—Ç–µ.</div></div>
        <div class="card"><div class="h5">–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤?</div><div class="muted">–ù–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–ü–æ–¥–ø–∏—Å–∫–∞ / –ë–∞–ª–∞–Ω—Å¬ª –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–µ—Å–µ—Ç—ã –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è 300/500/1000 –∏ –∑–∞–≤–µ—Ä—à–∏—Ç–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ.</div></div>
      </div>
    </div>
  </section>
</div>

<!-- Toasts -->
<div id="toasts" class="toast"></div>

<script>
const tg = window.Telegram?.WebApp || { initData:'', initDataUnsafe:{}, ready:()=>{}, expand:()=>{}, themeParams:{}, onEvent:()=>{} };
try{tg.ready();tg.expand();}catch{}

// State
const S = { lang:'ru', theme:'light', user:null, sub:null, balance:0, currency:'RUB', config:null, cart:{ period:null, traffic:null, devices:1, servers:[] } };

// i18n (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä; —Ä–∞—Å—à–∏—Ä—é –ø—Ä–∏ –≤–∞—à–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤)
const I18N = {
  ru: {
    title:'Remnawave', subtitle:'–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç Mini App', connect:'–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ', plan:'–ü–æ–¥–ø–∏—Å–∫–∞ / –ë–∞–ª–∞–Ω—Å', ref:'–†–µ—Ñ–µ—Ä–∞–ª—ã', devices:'–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ —Å–µ—Ä–≤–µ—Ä—ã', settings:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏', help:'–°–ø—Ä–∞–≤–∫–∞',
    copy:'–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å', openClient:'–û—Ç–∫—Ä—ã—Ç—å –∫–ª–∏–µ–Ω—Ç', testConn:'–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ',
    period:'–ü–µ—Ä–∏–æ–¥', traffic:'–¢—Ä–∞—Ñ–∏–∫', devicesL:'–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', serversL:'–°–µ—Ä–≤–µ—Ä—ã', total:'–ò—Ç–æ–≥–æ', buy:'–û—Ñ–æ—Ä–º–∏—Ç—å', balance:'–ë–∞–ª–∞–Ω—Å', fastTopup:'–ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ',
    enable:'–í–∫–ª—é—á–∏—Ç—å', disable:'–û—Ç–∫–ª—é—á–∏—Ç—å', same:'–í –¥–µ–Ω—å —Å–ø–∏—Å–∞–Ω–∏—è', day1:'–ó–∞ 1 –¥–µ–Ω—å', day3:'–ó–∞ 3 –¥–Ω—è',
    toastCopied:'–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ', toastError:'–û—à–∏–±–∫–∞',
  },
  en: {
    title:'Remnawave', subtitle:'Personal Mini App', connect:'Connect', plan:'Plan / Balance', ref:'Referrals', devices:'Devices & Servers', settings:'Settings', help:'Help',
    copy:'Copy', openClient:'Open client', testConn:'Test connection',
    period:'Period', traffic:'Traffic', devicesL:'Devices', serversL:'Servers', total:'Total', buy:'Purchase', balance:'Balance', fastTopup:'Quick top up',
    enable:'Enable', disable:'Disable', same:'On renewal day', day1:'1 day before', day3:'3 days before',
    toastCopied:'Copied', toastError:'Error',
  }
};

function t(key){ return I18N[S.lang]?.[key] || I18N.ru[key] || key }
function money(v){ try{return new Intl.NumberFormat(S.lang,{style:'currency',currency:S.currency||'RUB'}).format(v)}catch{return v+ ' '+(S.currency||'RUB')}}

// Theme & Lang init
(function initPrefs(){
  const lsL = localStorage.getItem('miniapp-lang');
  const lsT = localStorage.getItem('miniapp-theme');
  S.lang = (lsL||tg?.initDataUnsafe?.user?.language_code||'ru').startsWith('ru')?'ru':'en';
  S.theme = lsT || (tg?.themeParams?.bg_color && tg.themeParams.bg_color !== '#ffffff' ? 'dark':'light');
  applyLang(); applyTheme();
})();

function applyLang(){
  document.getElementById('lang').value = S.lang;
  document.getElementById('title').textContent = t('title');
  document.getElementById('subtitle').textContent = t('subtitle');
  document.getElementById('tab-connect').textContent = t('connect');
  document.getElementById('tab-plan').textContent = t('plan');
  document.getElementById('tab-ref').textContent = t('ref');
  document.getElementById('tab-devices').textContent = t('devices');
  document.getElementById('tab-settings').textContent = t('settings');
  document.getElementById('tab-help').textContent = t('help');
}
function applyTheme(){
  document.documentElement.setAttribute('data-theme', S.theme);
  document.getElementById('themeLabel').textContent = S.theme==='dark'?'Dark':'Light';
}

document.getElementById('lang').addEventListener('change', (e)=>{ S.lang = e.target.value; localStorage.setItem('miniapp-lang',S.lang); applyLang(); renderAll(); });
['theme','toggleTheme'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('click',()=>{ S.theme = S.theme==='dark'?'light':'dark'; localStorage.setItem('miniapp-theme',S.theme); applyTheme(); });});

// Tabs
const tabs = document.getElementById('tabs');
tabs.addEventListener('click',(e)=>{const btn=e.target.closest('.tab'); if(!btn) return; document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); btn.classList.add('active');
  const k=btn.dataset.tab; document.querySelectorAll('section[id^="sec-"]').forEach(s=>s.classList.add('hidden')); document.getElementById('sec-'+k).classList.remove('hidden');
  if(k==='plan') ensurePlanLoaded(); if(k==='devices') ensureDevicesLoaded(); if(k==='ref') ensureRefLoaded(); if(k==='connect') ensureServersLoaded();});

// Toasts
function toast(msg){ const wrap=document.getElementById('toasts'); const d=document.createElement('div'); d.className='msg'; d.textContent=msg; wrap.appendChild(d); setTimeout(()=>{d.style.opacity='0'; setTimeout(()=>d.remove(),300)},2400); }

// API
const API_BASE = '/miniapp';
async function api(path, data=null, method='POST'){ const opt={ method, headers:{'Content-Type':'application/json'}, body: data?JSON.stringify({initData:tg?.initData||'', ...data}):JSON.stringify({initData:tg?.initData||''}) };
  const res = await fetch(API_BASE+path, opt); if(!res.ok) throw new Error('HTTP '+res.status); return await res.json(); }

// Load config + session
async function bootstrap(){ try{
  S.config = await api('/app-config',{},'POST');
  const sess = await api('/session',{},'POST');
  S.user = sess.user; S.sub = sess.subscription; S.balance = sess.balance; S.currency = sess.currency||'RUB';
  renderAll(); }
  catch(e){ console.error(e); toast(t('toastError')); }}

function renderAll(){ renderConnect(); renderPlan(); renderRef(); renderDevices(); }

// CONNECT
function renderConnect(){ document.getElementById('h_connect_quick').textContent = S.lang==='ru'?'–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∑–∞ 30 —Å–µ–∫':'Connect in 30s';
  document.getElementById('badge_recommended').textContent = S.lang==='ru'?'–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º':'Recommended';
  document.getElementById('p_connect_pick').textContent = S.lang==='ru'?'1) –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É':'1) Pick your platform';
  document.getElementById('p_connect_copy').textContent = S.lang==='ru'?'2) –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –ø–æ–¥–ø–∏—Å–∫–∏':'2) Copy subscription link';
  document.getElementById('openClient').textContent = t('openClient'); document.getElementById('testConnect').textContent=t('testConn');
  const link = S.sub?.subscriptionLink || S.config?.subscription_link || '';
  document.getElementById('subLink').value = link;
}
function ensureServersLoaded(){ if(renderConnect.serversLoaded) return; loadServers(); }
async function loadServers(){ try{ const d = await api('/servers',{},'POST'); const wrap=document.getElementById('servers'); wrap.innerHTML='';
  (d.connected||[]).forEach(s=>{ const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div class="row" style="justify-content:space-between;gap:8px"><div class="row" style="gap:8px"><div class="kbd">${s.flag||'üåê'}</div><div><div class="h5">${s.name}</div><div class="muted">${s.location||''}</div></div></div><button class="btn btn-outline" data-sid="${s.id}">–û—Ç–∫–ª—é—á–∏—Ç—å</button></div>`; wrap.appendChild(c); });
  (d.available||[]).forEach(s=>{ const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div class="row" style="justify-content:space-between;gap:8px"><div class="row" style="gap:8px"><div class="kbd">${s.flag||'üåê'}</div><div><div class="h5">${s.name}</div><div class="muted">${s.location||''}</div></div></div><button class="btn btn-primary" data-sid="${s.id}">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button></div>`; wrap.appendChild(c); });
  wrap.addEventListener('click',(e)=>{ const b=e.target.closest('button[data-sid]'); if(!b) return; toggleServer(b.dataset.sid); });
  document.getElementById('serversSummary').textContent = `${(d.connected||[]).length} / ${(d.available||[]).length+(d.connected||[]).length}`;
  renderConnect.serversLoaded = true; }catch(e){ console.error(e); }}
async function toggleServer(id){ try{ await api('/servers/apply',{toggle:id},'POST'); toast('OK'); ensureServersLoaded(); }catch(e){ toast(t('toastError')); }}

// PLAN & BALANCE
function renderPlan(){ document.getElementById('h_subscription').textContent = S.lang==='ru'?'–ü–æ–¥–ø–∏—Å–∫–∞':'Subscription';
  const st=document.getElementById('subStatus'); const status = S.sub?.status||'‚Äî'; st.textContent = status==='active'?(S.lang==='ru'?'–ê–∫—Ç–∏–≤–Ω–∞':'Active'):status;
  document.getElementById('h_total').textContent = t('total'); document.getElementById('h_balance').textContent = t('balance');
  document.getElementById('p_fast_topup').textContent = t('fastTopup');
  document.getElementById('btnBuy').textContent = t('buy');
  document.getElementById('balanceVal').textContent = money(S.balance);
}
async function ensurePlanLoaded(){ if(ensurePlanLoaded.loaded) return; ensurePlanLoaded.loaded=true; try{
  const opts = await api('/subscription/options',{},'POST');
  // periods
  const pr = document.getElementById('periods'); pr.innerHTML='';
  (opts.periods||[]).forEach(p=>{ const b=document.createElement('button'); b.className='btn btn-outline'; b.dataset.val=p.value; const perMonth=p.per_month?` ‚Ä¢ ‚âà ${money(p.per_month)}/–º–µ—Å`:''; const save=p.discount?` ‚Ä¢ ‚àí${p.discount}%`:''; b.textContent=`${p.label}${save}${perMonth}`; b.addEventListener('click',()=>{S.cart.period=p.value; updatePrice(opts)}); pr.appendChild(b); });
  // traffic
  const tf = document.getElementById('traffic'); tf.innerHTML='';
  (opts.traffic||[]).forEach(x=>{ const b=document.createElement('button'); b.className='btn btn-outline'; b.dataset.val=x.value; b.textContent=x.label; b.addEventListener('click',()=>{S.cart.traffic=x.value; updatePrice(opts)}); tf.appendChild(b); });
  // devices
  document.getElementById('devMinus').addEventListener('click',()=>{ S.cart.devices=Math.max(1,(S.cart.devices||1)-1); document.getElementById('devValue').textContent=S.cart.devices; updatePrice(opts)});
  document.getElementById('devPlus').addEventListener('click',()=>{ S.cart.devices=Math.min(opts.devices?.max||10,(S.cart.devices||1)+1); document.getElementById('devValue').textContent=S.cart.devices; updatePrice(opts)});
  // servers picks (limit info)
  const sp=document.getElementById('srvPick'); sp.innerHTML=''; (opts.servers||[]).slice(0,10).forEach(s=>{ const b=document.createElement('button'); b.className='btn btn-outline'; b.textContent=s.name; b.addEventListener('click',()=>{ const i=S.cart.servers.indexOf(s.id); if(i>=0) S.cart.servers.splice(i,1); else S.cart.servers.push(s.id); b.classList.toggle('btn-primary'); updatePrice(opts) }); sp.appendChild(b); });
  // price
  updatePrice(opts);
  // pay methods
  const pm = await api('/payments/methods',{},'POST'); const pmw=document.getElementById('payMethods'); pmw.innerHTML='';
  (pm.methods||[]).forEach(m=>{ const b=document.createElement('button'); b.className='btn btn-outline'; b.textContent=m.title; b.dataset.method=m.code; pmw.appendChild(b); });
  pmw.addEventListener('click',(e)=>{ const b=e.target.closest('button[data-method]'); if(!b) return; createPayment(parseFloat(document.getElementById('topupAmount').value||0)||300, b.dataset.method) });
  // topup presets
  document.querySelectorAll('.preset').forEach(p=>p.addEventListener('click',()=>{ document.getElementById('topupAmount').value=p.dataset.amount }));
  document.getElementById('topupBtn').addEventListener('click',()=>{ const amt=parseFloat(document.getElementById('topupAmount').value||0); if(amt>0) createPayment(amt) });
  document.getElementById('btnBuy').addEventListener('click', submitPurchase);
 }catch(e){ console.error(e); toast(t('toastError')); }}

function updatePrice(opts){ // –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (–ø—Ä–∏–±–ª–∏–∂—ë–Ω–Ω–æ), —Å–µ—Ä–≤–µ—Ä –≤—Å—ë –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∏—Ç
  const p = (opts.price_base||0) + priceFromList(opts.periods, S.cart.period) + priceFromList(opts.traffic, S.cart.traffic) + (opts.devices?.unit_price||0)*((S.cart.devices||1)-1);
  document.getElementById('priceCurrent').textContent = money(p||0);
  const pm = approxPerMonth(opts, p); document.getElementById('pricePerMonth').textContent = pm?('‚âà '+money(pm)+'/–º–µ—Å'):'‚Äî';
  const disc = bestDiscount(opts, S.cart.period); const badge=document.getElementById('discountBadge'); if(disc){ badge.textContent = `–í—ã–≥–æ–¥–∞ ${disc}%`; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
}
function priceFromList(list, val){ if(!list) return 0; const it=list.find(x=>x.value===val); return it?.price||0 }
function approxPerMonth(opts, total){ const months = monthFromPeriod(S.cart.period, opts); return months? total/months : 0 }
function monthFromPeriod(val, opts){ const it=(opts.periods||[]).find(x=>x.value===val); return it?.months||0 }
function bestDiscount(opts, val){ const it=(opts.periods||[]).find(x=>x.value===val); return it?.discount||0 }

async function submitPurchase(){ try{ const r = await api('/subscription/purchase',{ cart:S.cart },'POST'); if(r.need_payment){ // –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); document.querySelector('[data-tab="plan"]').click(); }
  else{ toast('–û—Ñ–æ—Ä–º–ª–µ–Ω–æ'); await refreshBalance(); } }catch(e){ toast(t('toastError')); }}
async function refreshBalance(){ try{ const d = await api('/subscription',{},'POST'); S.sub=d.subscription; S.balance=d.balance; renderPlan(); }catch(e){}}

// Payments
async function createPayment(amount, method){ try{
  const res = await api('/payments/create',{ amount, method },'POST');
  if(res.url){ window.open(res.url,'_blank'); pollPayment(res.paymentId); }
  else if(res.intent){ // Stars / in-app
    pollPayment(res.paymentId);
  } else { toast('–°–æ–∑–¥–∞–Ω–æ'); pollPayment(res.paymentId); }
} catch(e){ toast(t('toastError')); }}
async function pollPayment(id){ const start=Date.now(); const wait=ms=>new Promise(r=>setTimeout(r,ms));
  while(Date.now()-start < 180000){ try{ const s = await api('/payments/status',{ paymentId:id },'POST'); if(s.status==='success'){ toast('–ü–ª–∞—Ç—ë–∂ –∑–∞—á–∏—Å–ª–µ–Ω'); await refreshBalance(); return } if(s.status==='failed' || s.status==='expired'){ toast('–ü–ª–∞—Ç—ë–∂ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω'); return } }catch(e){}
    await wait(5000);
  }
}

// REFERRALS
function ensureRefLoaded(){ if(ensureRefLoaded.loaded) return; loadRef(); }
async function loadRef(){ try{ const d = await api('/referral',{},'POST'); document.getElementById('refLink').value=d.link||''; document.getElementById('refInvited').textContent=d.invited||0; document.getElementById('refActive').textContent=d.active||0; document.getElementById('refEarned').textContent= money(d.earned||0); ensureRefLoaded.loaded=true; }catch(e){}}

// DEVICES & SERVERS tab
function ensureDevicesLoaded(){ if(ensureDevicesLoaded.loaded) return; loadDevicesAndServers(); }
async function loadDevicesAndServers(){ try{ const d = await api('/devices',{},'POST'); const w=document.getElementById('devices'); w.innerHTML=''; (d.devices||[]).forEach(dev=>{ const c=document.createElement('div'); c.className='row'; c.style.justifyContent='space-between'; c.innerHTML=`<div><div class="h5">${dev.name}</div><div class="muted">${dev.os||''} ‚Ä¢ ${dev.lastSeen||''}</div></div><button class="btn btn-outline" data-rm="${dev.id}">–°–±—Ä–æ—Å–∏—Ç—å</button>`; w.appendChild(c); });
 w.addEventListener('click', async (e)=>{ const b=e.target.closest('button[data-rm]'); if(!b) return; try{ await api('/devices/remove',{ id:b.dataset.rm },'POST'); toast('–°–±—Ä–æ—à–µ–Ω–æ'); loadDevicesAndServers(); }catch(_){ toast(t('toastError')); } });
 const s=document.getElementById('allServers'); s.innerHTML=''; (d.servers||[]).forEach(x=>{ const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div class="row" style="justify-content:space-between"><div class="row" style="gap:8px"><div class="kbd">${x.flag||'üåê'}</div><div><div class="h5">${x.name}</div><div class="muted">${x.location||''}</div></div></div><button class="btn ${x.connected?'btn-outline':'btn-primary'}" data-sid="${x.id}">${x.connected?'–û—Ç–∫–ª—é—á–∏—Ç—å':'–ü–æ–¥–∫–ª—é—á–∏—Ç—å'}</button></div>`; s.appendChild(c); });
 s.addEventListener('click',(e)=>{ const b=e.target.closest('button[data-sid]'); if(!b) return; toggleServer(b.dataset.sid); });
 ensureDevicesLoaded.loaded=true; }catch(e){}}

// Quick actions
['copySub','copyRef'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('click', async ()=>{ const val=document.getElementById(id==='copySub'?'subLink':'refLink').value; try{ await navigator.clipboard.writeText(val); toast(t('toastCopied')); }catch{ toast(t('toastError')); } });});

document.getElementById('openClient').addEventListener('click',()=>{ const link=document.getElementById('subLink').value; if(link) window.open(link,'_blank'); });
document.getElementById('testConnect').addEventListener('click',()=>toast('–ü—Ä–æ–≤–µ—Ä—è–µ–º‚Ä¶'));

tg.onEvent?.('themeChanged',()=>{ const dark = tg?.themeParams?.bg_color && tg.themeParams.bg_color!=='#ffffff'; S.theme = dark?'dark':'light'; applyTheme(); });

bootstrap();
</script>
</body>
</html>
